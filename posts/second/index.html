<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <title>Second | Jace&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="description" content=" 染色标示增强 [TOC]
1. 现有方案 在第一期的支付网关全链路压测中，通过在http请求头增加fake: 1来染色流量，实现上比较简单。
2. 场景补充 但在更复杂的场景中遇到了以下一些问题：
2.1 core-business的getAllParams接口 在upay-gateway作为调用方是的逻辑：
st=&gt;start: 调用开始（terminal_sn） e=&gt;end: 调用结束 fake=&gt;condition: 是否是压测流量 db=&gt;operation: 从原DB取数据 offset=&gt;operation: 偏移数据 st-&gt;db-&gt;fake fake(yes)-&gt;offset-&gt;e fake(no)-&gt;e 3. 增强方案 " />
  <meta name="author" content="jacexh" />
  <meta name="generator" content="Hugo 0.53" />
  <link href="http://blog.xuh.me/index.xml" rel="alternate" type="application/rss+xml" title="Jace&#39;s Blog Feed" />
  <link rel="shortcut icon" href="http://blog.xuh.me/favicon.ico" type="image/x-icon" />
  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://blog.xuh.me/assets/style-compat.css" />
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://blog.xuh.me/assets/style.css" />
  <!--<![endif]-->
</head>
<body>
<div class="pure-g">
  <div class="pure-u-1-24 pure-u-md-5-24"></div>
  <div class="pure-u-22-24 pure-u-md-14-24">
  <div class="navigation-header">
  <div class="pure-menu pure-menu-horizontal">
    <a class="pure-menu-heading pure-menu-link" href="/">
      Jace&#39;s Blog
    </a>
  </div>
</div>
<div class="navigation-content">
  <div class="pure-menu pure-menu-horizontal">
    <ul class="pure-menu-list">
      <li class="pure-menu-item">
        <a  class="pure-menu-link" href="/">Home</a>
      </li>
      <li class="pure-menu-item">
        <a  class="pure-menu-link" href="/posts">Posts</a>
      </li>
      <li class="pure-menu-item">
        <a  class="pure-menu-link" href="/tags">Tags</a>
      </li>
      <li class="pure-menu-item">
        <a  class="pure-menu-link" href="https://github.com/jacexh">Works</a>
      </li>
    </ul>
  </div>
</div>

  
<div>
  <div>
    <h1 class="post-title">Second</h1>
    <div class="post-meta">
  Date &#x5b;
    <time datetime="2019-01-17T15:23:40&#43;08:00">01-17-2019</time>
  &#x5d;
</div>

  </div>
  <div>

<h1 id="染色标示增强">染色标示增强</h1>

<p>[TOC]</p>

<h2 id="1-现有方案">1. 现有方案</h2>

<p>在第一期的支付网关全链路压测中，通过在<code>http</code>请求头增加<code>fake: 1</code>来染色流量，实现上比较简单。</p>

<h2 id="2-场景补充">2. 场景补充</h2>

<p>但在更复杂的场景中遇到了以下一些问题：</p>

<h3 id="2-1-core-business的getallparams接口">2.1 core-business的getAllParams接口</h3>

<p>在<code>upay-gateway</code>作为调用方是的逻辑：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-flow" data-lang="flow">st=&gt;start: 调用开始（terminal_sn）
e=&gt;end: 调用结束
fake=&gt;condition: 是否是压测流量
db=&gt;operation: 从原DB取数据
offset=&gt;operation: 偏移数据
st-&gt;db-&gt;fake
fake(yes)-&gt;offset-&gt;e
fake(no)-&gt;e</code></pre></div>
<h2 id="3-增强方案">3. 增强方案</h2>
</div>
</div>
  <div class="footer-content">
  <div class="pure-menu pure-menu-horizontal">
    <ul class="pure-menu-list">
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://github.com/jacexh">Github</a>
      </li>
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="https://twitter.com/jacexh">Twitter</a>
      </li>
      <li class="pure-menu-item">
        <a href="http://blog.xuh.me/index.xml" class="pure-menu-link">RSS</a>
      </li>
      <li class="pure-menu-item">
        <a class="pure-menu-link" id="btn-gototop">
          <span class="fixup">&#x21e7;&#xfe0e;</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="pure-menu pure-menu-horizontal">
    <ul class="pure-menu-list">
      <li class="pure-menu-item pure-menu-disabled">
        &copy; 2019 &mdash; xuh.me — All rights reserved.
      </li>
    </ul>
  </div>
</div>
<script>
  function setElementsClass(selector, value) {
    Array.prototype.forEach.call(
      document.querySelectorAll(selector),
      function(elem) { elem.className = value; }
    );
  }

  setElementsClass('img', 'pure-img');
  setElementsClass('table', 'pure-table');

  function onResize() {
      setElementsClass(
        '.pure-menu', document.documentElement.clientWidth >= 568 ?
              'pure-menu pure-menu-horizontal' : 'pure-menu'
      );
  }
  onResize();
  window.addEventListener('resize', onResize);

  document.getElementById('btn-gototop').addEventListener('click', function() {
    function scroll() {
      if (window.pageYOffset > 0) { setTimeout(scroll, 8); }
      window.scroll(0, window.pageYOffset - 128);
    }
    scroll();
  });
</script>

  </div>
  <div class="pure-u-1-24 pure-u-md-5-24"></div>
</div>
</body>
</html>
